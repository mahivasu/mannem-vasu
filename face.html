<!DOCTYPE html>
<html>
<head>
    <title>Face Counter Web App</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        video, canvas {
            border: 2px solid black;
            margin-top: 20px;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Face Counter Web Application</h1>
    <video id="video" width="640" height="480" autoplay muted></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <h2 id="count">Faces Detected: 0</h2>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    
    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let faceCascade;

        function onOpenCvReady() {
            // Load Haar Cascade for face detection
            let xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml', true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function() {
                let data = new Uint8Array(xhr.response);
                cv.FS_createDataFile('/', 'haarcascade_frontalface_default.xml', data, true, false, false);
                faceCascade = new cv.CascadeClassifier();
                faceCascade.load('haarcascade_frontalface_default.xml');
                startVideo();
            };
            xhr.send();
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(processVideo);
                })
                .catch(err => console.error(err));
        }

        function processVideo() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            let faces = new cv.RectVector();
            let msize = new cv.Size(0, 0);
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);

            // Draw rectangles around faces
            for (let i = 0; i < faces.size(); i++) {
                let face = faces.get(i);
                cv.rectangle(src, new cv.Point(face.x, face.y), new cv.Point(face.x + face.width, face.y + face.height), [0, 255, 0, 255], 2);
            }

            document.getElementById('count').innerText = `Faces Detected: ${faces.size()}`;
            cv.imshow('canvas', src);

            src.delete();
            gray.delete();
            faces.delete();

            requestAnimationFrame(processVideo);
        }
    </script>
</body>
</html>
